# CircleCI 2.0 configuration file for Babyl

version: 2
jobs:
  build:
    docker:
       - image: circleci/ruby:2.3.1
         environment:
           RAILS_ENV: test

    working_directory: ~/circleci-test

    steps:
      - checkout

      - run:
          name: Set up test DB
          command: |
            bundle exec rake db:schema:load

      - run:
          name: run tests
          command: |
            bundle exec rspec spec/

  deploy-staging:
    docker:
       - image: circleci/ruby:2.3.1

    working_directory: ~/circleci-test

    steps:
      - checkout

      - run:
          name: Run setup script
          command: |
            sh .circleci/setup-heroku.sh

      - add_ssh_keys:
          fingerprints:
            - "9a:dd:84:fb:3f:89:0b:dd:f2:89:63:09:b7:01:76:d7"

      - run:
          name: Deploy master to Heroku
          command: |
            git push git@heroku.com:$HEROKU_APP_NAME.git HEAD:refs/heads/master

      - run:
          name: DB Migrate
          command: |
            heroku run rake db:migrate --app $HEROKU_APP_NAME

      - run:
          name: Restart Dynos
          command: |
            heroku restart --app $HEROKU_APP_NAME

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build
      - deploy-staging:
          requires:
            - build
          filters:
             branches:
               only: master
      - hold:
         type: approval
         requires:
           - build
